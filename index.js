import 'dotenv/config';
import { Client, GatewayIntentBits, PermissionsBitField, ActionRowBuilder, ButtonBuilder, ButtonStyle, ChannelType } from 'discord.js';

// р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ Token р╣Вр╕лр╕ер╕Фр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕Зр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
if (!process.env.TOKEN) {
    console.error("тЭМ р╣Др╕бр╣Ир╕Юр╕Ъ TOKEN р╣Гр╕Щр╣Др╕Яр╕ер╣М .env");
    process.exit(1);
}

const client = new Client({
    intents: [
        GatewayIntentBits.Guilds,
        GatewayIntentBits.GuildMessages,
        GatewayIntentBits.MessageContent,
        GatewayIntentBits.GuildMembers
    ]
});

client.once('ready', () => {
    console.log(`тЬЕ р╕Ър╕нр╕Ч ${client.user.tag} р╕Юр╕гр╣Йр╕нр╕бр╕Чр╕│р╕Зр╕▓р╕Щр╣Бр╕ер╣Йр╕з!`);
});

// р╕гр╕░р╕Ър╕Ър╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╕лр╕▓р╕Бр╕Ър╕нр╕Чр╕ер╣Ир╕б
process.on("uncaughtException", async (error) => {
    console.error("тЭМ р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╕Чр╕╡р╣Ир╣Др╕бр╣Ир╣Др╕Фр╣Йр╕Ир╕▒р╕Фр╕Бр╕▓р╕г:", error);
    const guild = client.guilds.cache.first();
    if (guild) {
        const logChannel = guild.channels.cache.find(ch => ch.name === "ЁЯУЬ log-р╕Ър╕нр╕Ч");
        if (logChannel) {
            logChannel.send(`ЁЯЪи **р╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ:** р╕Ър╕нр╕Чр╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Бр╕ер╕░р╕нр╕▓р╕Ир╕ер╣Ир╕б!\n\`\`\`${error.message}\`\`\``);
        }
    }
});

const verifiedUsers = new Set();
let memberCountChannelId = null; // р╣Ар╕Бр╣Зр╕Ъ ID р╕Вр╕нр╕Зр╕Кр╣Ир╕нр╕Зр╣Бр╕кр╕Фр╕Зр╕Ир╕│р╕Щр╕зр╕Щр╕кр╕бр╕▓р╕Кр╕┤р╕Б

client.on('messageCreate', async (message) => {
    if (!message.guild || message.author.bot) return;

    if (message.content === "!setup") {
        if (!message.member.permissions.has(PermissionsBitField.Flags.Administrator)) {
            return message.reply("тЭМ р╕Др╕╕р╕Ур╣Др╕бр╣Ир╕бр╕╡р╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╣Гр╕Кр╣Йр╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Щр╕╡р╣Й!");
        }

        const category = await message.guild.channels.create({
            name: "ЁЯУМ р╕гр╕▒р╕Ър╕вр╕и",
            type: ChannelType.GuildCategory,
            permissionOverwrites: [
                {
                    id: message.guild.id,
                    allow: [PermissionsBitField.Flags.ViewChannel]
                }
            ]
        });

        const roleChannel = await message.guild.channels.create({
            name: "ЁЯФ░ р╕гр╕▒р╕Ър╕вр╕ир╕Чр╕╡р╣Ир╕Щр╕╡р╣И",
            type: ChannelType.GuildText,
            parent: category.id
        });

        await message.guild.channels.create({
            name: "ЁЯУЬ log-р╕гр╕▒р╕Ър╕вр╕и",
            type: ChannelType.GuildText,
            parent: category.id,
            permissionOverwrites: [
                {
                    id: message.guild.id,
                    deny: [PermissionsBitField.Flags.SendMessages]
                }
            ]
        });

        const verifyRow = new ActionRowBuilder().addComponents(
            new ButtonBuilder()
                .setCustomId("verify_user")
                .setLabel("ЁЯФН р╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕Хр╕▒р╕зр╕Хр╕Щ")
                .setStyle(ButtonStyle.Primary)
        );

        await roleChannel.send({
            content: "**ЁЯСЛ р╕вр╕┤р╕Щр╕Фр╕╡р╕Хр╣Йр╕нр╕Щр╕гр╕▒р╕Ъ! р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕Фр╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕Хр╕▒р╕зр╕Хр╕Щр╕Бр╣Ир╕нр╕Щр╕гр╕▒р╕Ър╕вр╕и**",
            components: [verifyRow]
        });

        message.reply("тЬЕ р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕лр╣Йр╕нр╕Зр╕гр╕▒р╕Ър╕вр╕ир╣Бр╕ер╕░р╕ер╣Зр╕нр╕Бр╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в!");
    }
    
    // ЁЯФ╣ р╕гр╕░р╕Ър╕Ър╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕Ир╕│р╕Щр╕зр╕Щр╕кр╕бр╕▓р╕Кр╕┤р╕Бр╣Бр╕Ър╕Ър╣Ар╕гр╕╡р╕вр╕ер╣Др╕Чр╕бр╣М
    if (message.content === "!members") {
        if (!message.member.permissions.has(PermissionsBitField.Flags.Administrator)) {
            return message.reply("тЭМ р╕Др╕╕р╕Ур╣Др╕бр╣Ир╕бр╕╡р╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╣Гр╕Кр╣Йр╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Щр╕╡р╣Й!");
        }

        let existingChannel = message.guild.channels.cache.find(ch => ch.name.startsWith("ЁЯСе р╕кр╕бр╕▓р╕Кр╕┤р╕Бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф:"));
        
        if (existingChannel) {
            memberCountChannelId = existingChannel.id; // р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б ID р╕Вр╕нр╕Зр╕Кр╣Ир╕нр╕Зр╕Чр╕╡р╣Ир╕бр╕╡р╕нр╕вр╕╣р╣И
            return message.reply("тЪая╕П р╕бр╕╡р╕Кр╣Ир╕нр╕Зр╕кр╕бр╕▓р╕Кр╕┤р╕Бр╕нр╕вр╕╣р╣Ир╣Бр╕ер╣Йр╕з!");
        }

        // р╕кр╕гр╣Йр╕▓р╕Зр╕Кр╣Ир╕нр╕З Voice Channel р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Бр╕кр╕Фр╕Зр╕Ир╕│р╕Щр╕зр╕Щр╕кр╕бр╕▓р╕Кр╕┤р╕Б
        const memberChannel = await message.guild.channels.create({
            name: `ЁЯСе р╕кр╕бр╕▓р╕Кр╕┤р╕Бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф: ${message.guild.memberCount}`,
            type: ChannelType.GuildVoice,
            permissionOverwrites: [
                {
                    id: message.guild.id,
                    deny: [PermissionsBitField.Flags.Connect] // р╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щр╕Др╕Щр╣Ар╕Вр╣Йр╕▓
                }
            ]
        });

        memberCountChannelId = memberChannel.id; // р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б ID р╕Кр╣Ир╕нр╕Зр╣Гр╕лр╕бр╣И
        message.reply(`тЬЕ р╕кр╕гр╣Йр╕▓р╕Зр╕Кр╣Ир╕нр╕З **${memberChannel.name}** р╣Бр╕ер╣Йр╕з!`);
    }
});

// р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕Ир╕│р╕Щр╕зр╕Щр╕кр╕бр╕▓р╕Кр╕┤р╕Бр╣Бр╕Ър╕Ър╣Ар╕гр╕╡р╕вр╕ер╣Др╕Чр╕бр╣М
async function updateMemberCount(guild) {
    let memberChannel = guild.channels.cache.find(ch => ch.name.startsWith("ЁЯСе р╕кр╕бр╕▓р╕Кр╕┤р╕Бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф:"));
    if (!memberChannel) return;

    try {
        await memberChannel.setName(`ЁЯСе р╕кр╕бр╕▓р╕Кр╕┤р╕Бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф: ${guild.memberCount}`);
        console.log(`ЁЯФД р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕Ир╕│р╕Щр╕зр╕Щр╕кр╕бр╕▓р╕Кр╕┤р╕Бр╣Ар╕Ыр╣Зр╕Щ: ${guild.memberCount}`);
    } catch (error) {
        console.error("тЭМ р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕Кр╣Ир╕нр╕Зр╕кр╕бр╕▓р╕Кр╕┤р╕Бр╣Др╕Фр╣Й:", error);
    }
}

// ЁЯУв р╣Ар╕бр╕╖р╣Ир╕нр╕бр╕╡р╕кр╕бр╕▓р╕Кр╕┤р╕Бр╣Ар╕Вр╣Йр╕▓
client.on("guildMemberAdd", async (member) => {
    await updateMemberCount(member.guild);
});

// тЭМ р╣Ар╕бр╕╖р╣Ир╕нр╕бр╕╡р╕кр╕бр╕▓р╕Кр╕┤р╕Бр╕нр╕нр╕Б
client.on("guildMemberRemove", async (member) => {
    await updateMemberCount(member.guild);
});

client.on("interactionCreate", async (interaction) => {
    if (!interaction.isButton()) return;

    const roleName = "р╕кр╕бр╕▓р╕Кр╕┤р╕Б";
    let role = interaction.guild.roles.cache.find(r => r.name === roleName);

    if (!role) {
        role = await interaction.guild.roles.create({
            name: roleName,
            color: "#00FF00"
        });
    }

    if (interaction.customId === "verify_user") {
        verifiedUsers.add(interaction.user.id);

        const roleRow = new ActionRowBuilder().addComponents(
            new ButtonBuilder()
                .setCustomId(`accept_role_${interaction.user.id}`)
                .setLabel("тЬЕ р╕гр╕▒р╕Ър╕вр╕и")
                .setStyle(ButtonStyle.Success)
        );

        await interaction.reply({
            content: "**тЬЕ р╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕Хр╕▒р╕зр╕Хр╕Щр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в! р╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Бр╕Фр╕гр╕▒р╕Ър╕вр╕ир╣Др╕Фр╣Йр╣Бр╕ер╣Йр╕з**",
            components: [roleRow],
            ephemeral: true
        });
        return;
    }

    if (interaction.customId.startsWith("accept_role_")) {
        const userId = interaction.user.id;
        if (!verifiedUsers.has(userId)) {
            return interaction.reply({ content: "тЭМ р╕Др╕╕р╕Ур╕Хр╣Йр╕нр╕Зр╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕Хр╕▒р╕зр╕Хр╕Щр╕Бр╣Ир╕нр╕Щ!", ephemeral: true });
        }

        if (interaction.member.roles.cache.has(role.id)) {
            return interaction.reply({ content: "тЭМ р╕Др╕╕р╕Ур╕бр╕╡р╕вр╕ир╕Щр╕╡р╣Йр╕нр╕вр╕╣р╣Ир╣Бр╕ер╣Йр╕з!", ephemeral: true });
        }

        await interaction.member.roles.add(role);
        await interaction.reply({ content: "тЬЕ р╕Др╕╕р╕Ур╣Др╕Фр╣Йр╕гр╕▒р╕Ър╕вр╕ир╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в!", ephemeral: true });

        const logChannel = interaction.guild.channels.cache.find(ch => ch.name === "ЁЯУЬ log-р╕гр╕▒р╕Ър╕вр╕и");
        if (logChannel) {
            logChannel.send(`ЁЯУв **${interaction.user.tag}** р╣Др╕Фр╣Йр╕гр╕▒р╕Ър╕вр╕и **${role.name}** р╣Бр╕ер╣Йр╕з!`);
        }
    }
});

client.on('messageCreate', async (message) => {
    if (!message.guild || message.author.bot) return;

    if (message.content === "!help") {
        const helpMessage = `
        **ЁЯУМ р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╕Вр╕нр╕Зр╕Ър╕нр╕Ч**
        ЁЯФ╣ **!setup** - р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕гр╕░р╕Ър╕Ър╕гр╕▒р╕Ър╕вр╕и (р╣Ар╕Йр╕Юр╕▓р╕░ Admin)
        ЁЯФ╣ **!members** - р╕кр╕гр╣Йр╕▓р╕Зр╕лр╣Йр╕нр╕Зр╣Бр╕кр╕Фр╕Зр╕Ир╕│р╕Щр╕зр╕Щр╕кр╕бр╕▓р╕Кр╕┤р╕Б (р╣Ар╕Йр╕Юр╕▓р╕░ Admin)
        
        **тЬЕ р╕гр╕░р╕Ър╕Ър╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕Хр╕▒р╕зр╕Хр╕Щ & р╕гр╕▒р╕Ър╕вр╕и**
        - р╣Ар╕Вр╣Йр╕▓р╣Др╕Ыр╕Чр╕╡р╣Ир╕лр╣Йр╕нр╕З **"ЁЯФ░ р╕гр╕▒р╕Ър╕вр╕ир╕Чр╕╡р╣Ир╕Щр╕╡р╣И"** 
        - р╕Бр╕Фр╕Ыр╕╕р╣Ир╕б **ЁЯФН р╕вр╕╖р╕Щр╕вр╕▒р╕Щр╕Хр╕▒р╕зр╕Хр╕Щ** р╣Бр╕ер╣Йр╕зр╕Бр╕Ф **тЬЕ р╕гр╕▒р╕Ър╕вр╕и** р╣Ар╕Юр╕╖р╣Ир╕нр╕гр╕▒р╕Ър╕вр╕и "р╕кр╕бр╕▓р╕Кр╕┤р╕Б"

        **ЁЯСе р╕гр╕░р╕Ър╕Ър╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕Ир╕│р╕Щр╕зр╕Щр╕кр╕бр╕▓р╕Кр╕┤р╕Б**
        - р╕Др╕│р╕кр╕▒р╣Ир╕З **!members** р╕кр╕гр╣Йр╕▓р╕Зр╕лр╣Йр╕нр╕Зр╣Бр╕кр╕Фр╕Зр╕Ир╕│р╕Щр╕зр╕Щр╕кр╕бр╕▓р╕Кр╕┤р╕Б
        - р╣Ар╕бр╕╖р╣Ир╕нр╕бр╕╡р╕Др╕Щр╣Ар╕Вр╣Йр╕▓/р╕нр╕нр╕Бр╣Ар╕Лр╕┤р╕гр╣Мр╕Яр╣Ар╕зр╕нр╕гр╣М р╕лр╣Йр╕нр╕Зр╕Ир╕░р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤

        **ЁЯЪи р╕гр╕░р╕Ър╕Ър╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щ**
        - р╕лр╕▓р╕Бр╕Ър╕нр╕Чр╕ер╣Ир╕б р╕Ир╕░р╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╣Гр╕Щр╕лр╣Йр╕нр╕З **"ЁЯУЬ log-р╕Ър╕нр╕Ч"**
        - р╣Ар╕бр╕╖р╣Ир╕нр╕бр╕╡р╕Др╕Щр╣Др╕Фр╣Йр╕гр╕▒р╕Ър╕вр╕и р╕Ир╕░р╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╣Гр╕Щр╕лр╣Йр╕нр╕З **"ЁЯУЬ log-р╕гр╕▒р╕Ър╕вр╕и"**

        **ЁЯТб р╕Др╕│р╕кр╕▒р╣Ир╕Зр╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕бр╣Гр╕Щр╕нр╕Щр╕▓р╕Др╕Х**
        - р╕лр╕▓р╕Бр╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╣Ар╕Юр╕┤р╣Ир╕бр╕Др╕│р╕кр╕▒р╣Ир╕Зр╣Гр╕лр╕бр╣И р╣Бр╕Ир╣Йр╕Зр╣Гр╕лр╣Йр╣Бр╕нр╕Фр╕бр╕┤р╕Щр╣Ар╕Юр╕┤р╣Ир╕бр╣Др╕Фр╣Йр╣Ар╕ер╕в!
        `;

        message.channel.send(helpMessage);
    }
});

// р╕гр╕░р╕Ър╕Ър╕лр╕ер╕▒р╕Зр╕Ър╣Йр╕▓р╕Щ (Backend) р╕Вр╕нр╕Зр╣Ар╕зр╣Зр╕Ър╣Ар╕Лр╕┤р╕гр╣Мр╕Яр╣Ар╕зр╕нр╕гр╣М
import express from 'express';
import path from 'path';

const app = express();
const port = process.env.PORT || 3000;

// р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╣Гр╕лр╣Й Express р╣Гр╕Кр╣Й EJS р╣Ар╕Ыр╣Зр╕Щ Template Engine
app.set("view engine", "ejs");
app.set("views", path.join(process.cwd(), "views"));

app.use(express.static("public"));

// р╕кр╕гр╣Йр╕▓р╕З Route р╕кр╕│р╕лр╕гр╕▒р╕Ър╕лр╕Щр╣Йр╕▓ Dashboard
app.get("/", (req, res) => {
    res.render("dashboard", { bot: client });
});

// р╣Гр╕лр╣Йр╣Ар╕зр╣Зр╕Ър╣Ар╕Лр╕┤р╕гр╣Мр╕Яр╣Ар╕зр╕нр╕гр╣Мр╣Ар╕гр╕┤р╣Ир╕бр╕Чр╕│р╕Зр╕▓р╕Щ
app.listen(PORT, () => {
    console.log(`ЁЯМР Web Dashboard р╣Ар╕Ыр╕┤р╕Фр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕Чр╕╡р╣И http://localhost:${PORT}`);
});

// р╕гр╕░р╕Ър╕Ър╣Ар╕ир╕гр╕йр╕Рр╕Бр╕┤р╕И (Economy System)
import { getUserBalance, addUserBalance, setUserBalance } from "./database.js";

client.on("messageCreate", async (message) => {
    if (message.author.bot) return;

    const args = message.content.split(" ");
    const command = args.shift().toLowerCase();

    if (command === "!balance") {
        const balance = getUserBalance(message.author.id);
        message.reply(`ЁЯТ░ р╕Др╕╕р╕Ур╕бр╕╡р╣Ар╕Зр╕┤р╕Щ: ${balance} ЁЯТ╡`);
    }

    if (command === "!daily") {
        addUserBalance(message.author.id, 100);
        message.reply("ЁЯОБ р╕Др╕╕р╕Ур╣Др╕Фр╣Йр╕гр╕▒р╕Ър╣Ар╕Зр╕┤р╕Щр╕гр╕▓р╕вр╕зр╕▒р╕Щ 100 ЁЯТ╡!");
    }

    if (command === "!work") {
        const amount = Math.floor(Math.random() * 500) + 100;
        addUserBalance(message.author.id, amount);
        message.reply(`ЁЯТ╝ р╕Др╕╕р╕Ур╕Чр╕│р╕Зр╕▓р╕Щр╣Бр╕ер╕░р╣Др╕Фр╣Йр╕гр╕▒р╕Ъ ${amount} ЁЯТ╡!`);
    }

    if (command === "!leaderboard") {
        const rows = db.prepare("SELECT id, balance FROM users ORDER BY balance DESC LIMIT 5").all();
        let leaderboard = "ЁЯПЖ **р╕нр╕▒р╕Щр╕Фр╕▒р╕Ър╣Ар╕ир╕гр╕йр╕Рр╕╡р╕Вр╕нр╕Зр╣Ар╕Лр╕┤р╕гр╣Мр╕Яр╣Ар╕зр╕нр╕гр╣М** ЁЯПЖ\n";
        rows.forEach((row, index) => {
            leaderboard += `${index + 1}. <@${row.id}> - ЁЯТ╡ ${row.balance}\n`;
        });
        message.channel.send(leaderboard);
    }
});



client.login(process.env.TOKEN);
 