import 'dotenv/config';
import express from 'express';
import path from 'path';
import { Client, GatewayIntentBits, PermissionsBitField, ActionRowBuilder, ButtonBuilder, ButtonStyle, ChannelType } from 'discord.js';

// ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Token ‡πÇ‡∏´‡∏•‡∏î‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
if (!process.env.TOKEN) {
    console.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö TOKEN ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå .env");
    process.exit(1);
}

const client = new Client({
    intents: [
        GatewayIntentBits.Guilds,
        GatewayIntentBits.GuildMessages,
        GatewayIntentBits.MessageContent,
        GatewayIntentBits.GuildMembers
    ]
});

client.once('ready', () => {
    console.log(`‚úÖ ‡∏ö‡∏≠‡∏ó ${client.user.tag} ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß!`);
});

// ‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏´‡∏≤‡∏Å‡∏ö‡∏≠‡∏ó‡∏•‡πà‡∏°
process.on("uncaughtException", async (error) => {
    console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£:", error);
    const guild = client.guilds.cache.first();
    if (guild) {
        const logChannel = guild.channels.cache.find(ch => ch.name === "üìú log-‡∏ö‡∏≠‡∏ó");
        if (logChannel) {
            logChannel.send(`üö® **‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:** ‡∏ö‡∏≠‡∏ó‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏à‡∏•‡πà‡∏°!\n\`\`\`${error.message}\`\`\``);
        }
    }
});

// ‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö !setup ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
client.on('messageCreate', async (message) => {
    if (!message.guild || message.author.bot) return;

    if (message.content === "!setup") {
        if (!message.member.permissions.has(PermissionsBitField.Flags.Administrator)) {
            return message.reply("‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ô‡∏µ‡πâ!");
        }

        const category = await message.guild.channels.create({
            name: "üìå ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô",
            type: ChannelType.GuildCategory,
            permissionOverwrites: [
                {
                    id: message.guild.id,
                    allow: [PermissionsBitField.Flags.ViewChannel]
                }
            ]
        });

        const verifyChannel = await message.guild.channels.create({
            name: "üî∞ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô",
            type: ChannelType.GuildText,
            parent: category.id
        });

        await message.guild.channels.create({
            name: "üìú log-‡∏£‡∏±‡∏ö‡∏¢‡∏®",
            type: ChannelType.GuildText,
            parent: category.id,
            permissionOverwrites: [
                {
                    id: message.guild.id,
                    deny: [PermissionsBitField.Flags.SendMessages]
                }
            ]
        });

        const verifyRow = new ActionRowBuilder().addComponents(
            new ButtonBuilder()
                .setCustomId("start_verification")
                .setLabel("üîç ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô")
                .setStyle(ButtonStyle.Primary)
        );

        await verifyChannel.send({
            content: "**üëã ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏¢‡∏®**",
            components: [verifyRow]
        });

        message.reply("‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
    }
});

// ‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
client.on("interactionCreate", async (interaction) => {
    if (!interaction.isButton()) return;

    if (interaction.customId === "start_verification") {
        const roleRow = new ActionRowBuilder().addComponents(
            new ButtonBuilder()
                .setCustomId(`accept_role_${interaction.user.id}`)
                .setLabel("‚úÖ ‡∏£‡∏±‡∏ö‡∏¢‡∏®")
                .setStyle(ButtonStyle.Success)
        );

        await interaction.reply({
            content: "**‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏¢‡∏®**",
            components: [roleRow],
            ephemeral: true
        });
    }

    if (interaction.customId.startsWith("accept_role_")) {
        const roleName = "‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å";
        let role = interaction.guild.roles.cache.find(r => r.name === roleName);

        if (!role) {
            role = await interaction.guild.roles.create({
                name: roleName,
                color: "#00FF00"
            });
        }

        if (interaction.member.roles.cache.has(role.id)) {
            return interaction.reply({ content: "‚ùå ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏¢‡∏®‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß!", ephemeral: true });
        }

        await interaction.member.roles.add(role);
        await interaction.reply({ content: "‚úÖ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏®‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!", ephemeral: true });

        const logChannel = interaction.guild.channels.cache.find(ch => ch.name === "üìú log-‡∏£‡∏±‡∏ö‡∏¢‡∏®");
        if (logChannel) {
            logChannel.send(`üì¢ **${interaction.user.tag}** ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏® **${role.name}** ‡πÅ‡∏•‡πâ‡∏ß!`);
        }
    }
});

// ‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å
client.on("guildMemberAdd", async (member) => {
    const welcomeChannel = member.guild.channels.cache.find(ch => ch.name === "üì¢ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å");
    if (welcomeChannel) {
        welcomeChannel.send(`üëã **‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö** <@${member.id}> ‡∏™‡∏π‡πà‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå! üéâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á **üî∞ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô**`);
    }
});

client.on("guildMemberRemove", async (member) => {
    const leaveChannel = member.guild.channels.cache.find(ch => ch.name === "üì¢ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å");
    if (leaveChannel) {
        leaveChannel.send(`‚ùå **${member.user.tag}** ‡πÑ‡∏î‡πâ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß... üò¢`);
    }
});

// ‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö Web Dashboard
const app = express();
const PORT = process.env.PORT || 8080;

app.set("view engine", "ejs");
app.set("views", path.join(process.cwd(), "views"));
app.use(express.static("public"));

app.get("/", (req, res) => {
    res.render("dashboard", { botStatus: "‚úÖ ‡∏ö‡∏≠‡∏ó‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô!" });
});

app.listen(PORT, () => {
    console.log(`üåê Web Dashboard ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà https://my-discord-bot-osbe.onrender.com`);
});

// ‚úÖ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á !help
client.on("messageCreate", async (message) => {
    if (message.content === "!help") {
        const helpMessage = `
        **üìå ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ö‡∏≠‡∏ó**
        üîπ **!setup** - ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏¢‡∏® (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin)
        üîπ **!members** - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin)
        
        **‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô & ‡∏£‡∏±‡∏ö‡∏¢‡∏®**
        - ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á **"üî∞ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô"** 
        - ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° **üîç ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô** ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î **‚úÖ ‡∏£‡∏±‡∏ö‡∏¢‡∏®** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏¢‡∏® "‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å"

        **üì¢ ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤-‡∏≠‡∏≠‡∏Å**
        - ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á **"üì¢ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å"**
        - ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á **"üì¢ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏≠‡∏≠‡∏Å"**

        **üö® ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô**
        - ‡∏´‡∏≤‡∏Å‡∏ö‡∏≠‡∏ó‡∏•‡πà‡∏° ‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á **"üìú log-‡∏ö‡∏≠‡∏ó"**
        - ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏® ‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á **"üìú log-‡∏£‡∏±‡∏ö‡∏¢‡∏®"**
        `;
        message.channel.send(helpMessage);
    }
});

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
async function updateServerStats(guild) {
    if (!guild) return;
    
    // ‡∏´‡∏≤ Channel ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
    let memberCountChannel = guild.channels.cache.find(ch => ch.name.startsWith("üë• ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å:"));
    let textChannelCount = guild.channels.cache.find(ch => ch.name.startsWith("üí¨ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:"));
    let voiceChannelCount = guild.channels.cache.find(ch => ch.name.startsWith("üîä ‡πÄ‡∏™‡∏µ‡∏¢‡∏á:"));
    let roleCount = guild.channels.cache.find(ch => ch.name.startsWith("üé≠ ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó:"));

    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Channel, ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà
    if (!memberCountChannel) {
        memberCountChannel = await guild.channels.create({
            name: `üë• ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ${guild.memberCount}`,
            type: ChannelType.GuildVoice,
            permissionOverwrites: [{ id: guild.id, deny: [PermissionsBitField.Flags.Connect] }]
        });
    }

    if (!textChannelCount) {
        textChannelCount = await guild.channels.create({
            name: `üí¨ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: ${guild.channels.cache.filter(ch => ch.type === ChannelType.GuildText).size}`,
            type: ChannelType.GuildVoice,
            permissionOverwrites: [{ id: guild.id, deny: [PermissionsBitField.Flags.Connect] }]
        });
    }

    if (!voiceChannelCount) {
        voiceChannelCount = await guild.channels.create({
            name: `üîä ‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ${guild.channels.cache.filter(ch => ch.type === ChannelType.GuildVoice).size}`,
            type: ChannelType.GuildVoice,
            permissionOverwrites: [{ id: guild.id, deny: [PermissionsBitField.Flags.Connect] }]
        });
    }

    if (!roleCount) {
        roleCount = await guild.channels.create({
            name: `üé≠ ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ${guild.roles.cache.size}`,
            type: ChannelType.GuildVoice,
            permissionOverwrites: [{ id: guild.id, deny: [PermissionsBitField.Flags.Connect] }]
        });
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
    try {
        await memberCountChannel.setName(`üë• ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ${guild.memberCount}`);
        await textChannelCount.setName(`üí¨ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: ${guild.channels.cache.filter(ch => ch.type === ChannelType.GuildText).size}`);
        await voiceChannelCount.setName(`üîä ‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ${guild.channels.cache.filter(ch => ch.type === ChannelType.GuildVoice).size}`);
        await roleCount.setName(`üé≠ ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ${guild.roles.cache.size}`);
        console.log(`üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Server Stats ‡∏Ç‡∏≠‡∏á ${guild.name}`);
    } catch (error) {
        console.error("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡πà‡∏≠‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÑ‡∏î‡πâ:", error);
    }
}

// üì¢ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤
client.on("guildMemberAdd", async (member) => {
    await updateServerStats(member.guild);
});

// ‚ùå ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏≠‡∏≠‡∏Å
client.on("guildMemberRemove", async (member) => {
    await updateServerStats(member.guild);
});


// ‚úÖ ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ö‡∏≠‡∏ó
client.login(process.env.TOKEN);
